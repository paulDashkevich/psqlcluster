# PostgreSQL cluster

+ Consul-server, Consul-client, Consul-template
+ pgbouncer
+ PostgreSQL cluster
+ patroni 
+ Ansible
+ Nginx
+ php-fpm with pool
+ pacemaker ( + quorum device)
+ nextcloud (http)
+ keepalived
+ clvm
+ iscsi + multipath


# –ó–∞–¥–∞—á–∞: —Ä–∞—Å–∫–∞—Ç–∞—Ç—å psql-–∫–ª–∞—Å—Ç–µ—Ä, –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Ñ—ç–π–ª–æ–≤–µ—Ä üõ∞Ô∏è

–†–µ—à–µ–Ω–∏–µ:

–°–æ–∑–¥–∞—ë—Ç—Å—è iscsi —Ç–∞—Ä–≥–µ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ —á–µ—Ä–µ–∑ –º—É–ª—å—Ç–∏–ø–∞—Å.

–ö–ª–∞—Å—Ç–µ—Ä —Å–æ–±—Ä–∞–ª –∏–∑ 2 –Ω–æ–¥ (—Ç.–∫. —Ñ—ç–π–ª–æ–≤–µ—Ä, —Å—Ö–µ–º–∞ –∞/–±), —Ç—Ä–µ—Ç—å—è –Ω–æ–¥–∞ - –∞—Ä–±–∏—Ç—Ä.

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—ç–π—Å–º—ç–π–∫–µ—Ä–∞ —Å –∫–æ—Ä–æ—Å–∏–Ω–∫–æ–º –∏ –∫–≤–æ—Ä—É–º–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –≤ –æ–¥–∏–Ω –∫–ª–∞—Å—Ç–µ—Ä

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é keepalived, nginx, php-fpm –∏ –∑–∞–≤–∏—Å–∏—Å–º–æ—Å—Ç–∏

–î–æ–±–∞–≤–ª—è—é —Ä–µ—Å—É—Ä—Å—ã –∫–ª–∞—Å—Ç–µ—Ä–∞, —Ç–∞–∫–∏–µ –∫–∞–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä (—Å–ª–µ–∂–µ–Ω–∏–µ –∑–∞ nginx), —Ä–µ—Å—É—Ä—Å keepalived –∏ php-fpm.

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è Consul'—ã. –°–µ—Ä–≤–µ—Ä, –∫–ª–∏–µ–Ω—Ç –∏ —à–∞–±–ª–æ–Ω, –ø–æ—Å–ª–µ –Ω–∏—Ö - pgbouncer.

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤—Ç–æ—Ä–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –Ω–æ —É–∂–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö PostgreSQL

–°—Ç–∞–≤–∏–º –ø–∞—Ä—Ç—Ä–æ–Ω–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º.

–ü–æ—Å–ª–µ —Ä–∞—Å–∫–∞—Ç–∫–∏ —Ç–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∞ –∏ –∞–Ω—Å–∏–±–ª–∞ - –∑–∞—Ö–æ–¥–∏–º –ø–æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º—É –Ω–∞ –≤—ã—Ö–æ–¥–µ –∞–¥—Ä–µ—Å—É —Ç–∏–ø–∞
```
reverse_dns = [
  "ip-185-177-92-37.ah-server.com",
]
```
–ó–∞–ø–æ–ª–Ω—è–µ–º –ª–æ–≥–∏–Ω –∏ –∂–µ–ª–∞–µ–º—ã–π –ø–∞—Ä–æ–ª—å, –∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö - –≤—ã–±–∏—Ä–∞–µ–º PostgreSQL, –≤–≤–æ–¥–∏–º –ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å –∏ –∏–º—è –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - nextcloud –∏ –ø–æ—Ä—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ  localhost:5432–í–∞–∂–Ω–æ! –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–∞–Ω–Ω—ã—Ö nextcloud –æ–±—è–∑–∞–Ω —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —à–∞—Ä–µ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
```
/mnt/gfs2/nextcloud
```
–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã —Å—Ç–µ–Ω–¥–∞:

–ù–∞ –≤—Ö–æ–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –Ω–∂–∏–Ω–∫—Å, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–ª–∞–≤–∞—é—â–∏–π –∞–¥—Ä–µ—Å –∫–∏–ø–∞–ª–∏–≤–¥–∞. –ö–ª–∞—Å—Ç–µ—Ä –ø–µ–π—Å–º–µ–π–∫–µ—Ä–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –∫–∏–ø–∞–ª–∏–≤–¥–∞ –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∞–¥—Ä–µ—Å –Ω–∞ –Ω–æ–¥—É web0 (–Ω–æ–¥–∞ web1  -  —Ä–µ–∑–µ—Ä–≤–Ω–∞—è). –í —Å–ª—É—á–∞–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å—Ç—Ä–æ—è –ª—é–±–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –∏–ª–∏ –≤ —Ü–µ–ª–æ–º –Ω–æ–¥—ã web0 - –ø—ç–π—Å–º–µ–π–∫–µ—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ –Ω–æ–¥–µ web1. –ü–æ—Ç–µ—Ä–∏ –≤ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥. –†–∞–±–æ—Ç–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö:2 –Ω–æ–¥—ã –ø–æ—Å—Ç–≥—Ä–µ—Å–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–∞—Ç—Ä–æ–Ω–∏, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –≤ –∫–æ–Ω—Å—É–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∏–º—è –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã. –ò–∑ –∫–æ–Ω—Å—É–ª–∞ –∑–∞–±–∏—Ä–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –∏ –∏–º–µ–Ω–∏ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–≥–±–∞—É–Ω—Å–µ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–µ—Å—Ç–∞—Ä—Ç–æ–º —Å–µ—Ä–≤–∏—Å–∞, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –Ω–µ —Ç–µ—Ä—è—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ –±—ã–ª–æ —É–ª–æ–≤–∏—Ç—å —Å–º—ã—Å–ª: –Ω–æ–¥—ã –ø–æ—Å—Ç–≥—Ä–µ—Å–∞ –≤—ã–±–∏—Ä–∞—é—Ç –º–∞—Å—Ç–µ—Ä–∞ –≤ —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –∏ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–∞—Ç—Ä–æ–Ω–∏ –≤ –∫–æ–Ω—Å—É–ª, –∞ –∫–æ–Ω—Å—É–ª –ø–æ—Ç–æ–º –∏–∑–º–µ–Ω—è–µ—Ç –∞–¥—Ä–µ—Å –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–≥–±–∞—É–Ω—Å–µ—Ä–∞. 

–ü–æ –∏—Ç–æ–≥—É —Ä–∞–±–æ—Ç üîÆ

–ö–ª–∞—Å—Ç–µ—Ä –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–∫–∞–∑, —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –¥–∞—É–Ω—Ç–∞–π–º –Ω–µ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç. –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.
